version: "3.9"

networks:
  default:
    name: instill-network

services:
  mgmt_backend_migrate:
    container_name: mgmt-backend-migrate
    build:
      context: .
    image: instill/mgmt-backend:dev
    restart: on-failure
    environment:
      CFG_DATABASE_HOST: pg_sql
      CFG_DATABASE_PORT: 5432
      CFG_DATABASE_USERNAME: postgres
      CFG_DATABASE_PASSWORD: password
    volumes:
      - ./config:/mgmt-backend/config
    entrypoint: ./mgmt-backend-migrate
    depends_on:
      pg_sql:
        condition: service_healthy

  mgmt_backend_init:
    container_name: mgmt-backend-init
    build:
      context: .
    image: instill/mgmt-backend:dev
    restart: on-failure
    environment:
      CFG_DATABASE_HOST: pg_sql
      CFG_DATABASE_PORT: 5432
      CFG_DATABASE_USERNAME: postgres
      CFG_DATABASE_PASSWORD: password
    volumes:
      - ./config:/mgmt-backend/config
    entrypoint: ./mgmt-backend-init
    depends_on:
      - mgmt_backend_migrate

  mgmt_backend:
    container_name: mgmt-backend
    build:
      context: .
    image: instill/mgmt-backend:dev
    restart: unless-stopped
    environment:
      CFG_SERVER_PORT: 8080
      CFG_SERVER_DISABLEUSAGE: ${DISABLEUSAGE}
      CFG_SERVER_CORSORIGINS: http://localhost:3000
      CFG_SERVER_EDITION: local-ce:dev
      CFG_DATABASE_HOST: pg_sql
      CFG_DATABASE_PORT: 5432
      CFG_DATABASE_USERNAME: postgres
      CFG_DATABASE_PASSWORD: password
    ports:
      - 8080:8080
    volumes:
      - ./config:/mgmt-backend/config
    depends_on:
      - mgmt_backend_init

  pg_sql:
    container_name: pg-sql
    image: postgres:14.1-alpine
    restart: unless-stopped
    ports:
      - 5432:5432
    environment:
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      timeout: 20s
      retries: 10
